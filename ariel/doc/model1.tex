\section{Simple Model With No Peculiar Velocities}
\label{sec:simple_noPV}
Consider a simple model in which peculiar velocities are not included and the background cosmology is known.
In this case observed redshifts can be
converted to distances and observed magnitudes can be converted to absolute magnitudes.

\subsection{Data}
\begin{description}
    \item[$N$:] Total number of galaxies.
    \item[$\hat x_i$, $\sigma_{x,i}$:] Observed $\log\!\left(\frac{V_{\text{rot}}}{V_0}\right)$ and uncertainty for galaxy $i$.
    \item[$\hat y_i$, $\sigma_{y,i}$:] Observed absolute magnitude and uncertainty for galaxy $i$.  The conversion from observed
    to absolute magnitude is possible under the assumptions of no peculiar velocities, known background cosmology, and negligible redshift measurement uncertainties.
\end{description}

\subsection{Parameters}
\begin{description}
    \item[$s$, $c$:] Slope and intercept of the Tully-Fisher relation.
    \item[$\sigma_{\text{int},x}$, $\sigma_{\text{int},y}$ :] Intrinsic scatter in the $x$-, $y$-directions.
    \item[$y_{\text{TF},i}$:] Latent ``on-relation'' absolute magnitude for galaxy $i$.
    \item[$x_i$, $y_i$:] Latent true $x$, $y$  for galaxy $i$.
\end{description}

\subsection{Model}
\label{sec:model}

Each galaxy has a latent parameter that determines its TF properties.  The galaxy absolute magnitude and
rotation velocity are drawn independently and
probabilistically based on this parameter using the TF relation.  Measurement errors are
independent and normally distributed.  Specifically, for each galaxy $i$:
\begin{align}
y_i \mid y_{\text{TF},i} &\sim \mathcal N(y_{\text{TF},i},\sigma_{\text{int},y})\\
x_i \mid y_{\text{TF},i}, s, c &\sim \mathcal N\!\left(\frac{y_{\text{TF},i}-c}{s},\sigma_{\text{int},x}\right),\\
\hat x_i \mid x_i &\sim \mathcal N(x_i,\sigma_{x,i}),\\
\hat y_i \mid y_i &\sim \mathcal N(y_i,\sigma_{y,i}).
\end{align}
The velocity uncertainties are normal in log-space, which is probably not entirely accurate but may be sufficient for our purposes.
The benefit of this model is that the likelihood for each galaxy can be computed in closed form, which makes inference tractable and efficient.

\subsection{Complete Sample}
It is illustrative to consider a model that does not include sample selection, helping us to
prepare for a model, discussed in \S\ref{sec:selection}, which includes sample selection as needed for the DESI TF sample.

\subsubsection{Total Likelihood}
Let $\theta \equiv \big(s,c,\sigma_{\text{int},x},\sigma_{\text{int},y}\big)$.
The total likelihood is
\begin{align}
\mathcal L(\theta;\{\hat x_i\},\{\hat y_i\})
= \prod_{i=1}^{N} \mathcal L_i(\theta;\hat x_i,\hat y_i),
\end{align}
where
\begin{align}
\mathcal L_i
&= p(\hat x_i,\hat y_i \mid \theta).
\end{align}
\subsubsection{Likelihood for an Individual Galaxy}

Marginalizing over latent variables given the model parameter dependencies in \S\ref{sec:model}:
\begin{align}
\mathcal L_i
&= \int dx_i\,dy_i\,dy_{\text{TF}}\;
p(\hat x_i\mid x_i)\,p(\hat y_i\mid y_i)\,
p(x_i\mid y_{\text{TF}},s,c)\,p(y_i\mid y_{\text{TF}})\,p(y_{\text{TF}}).
\end{align}

Convolving intrinsic and measurement scatter gives
\begin{align}
\sigma_{1,i}^2 &= \sigma_{x,i}^2+\sigma_{\text{int},x}^2,\\
\sigma_{2,i}^2 &= \sigma_{y,i}^2+\sigma_{\text{int},y}^2,
\end{align}
so that
\begin{align}
\hat x_i \mid y_{\text{TF},i} &\sim \mathcal N\!\left(\frac{y_{\text{TF},i}-c}{s},\sigma_{1,i}\right),\\
\hat y_i \mid y_{\text{TF},i} &\sim \mathcal N(y_{\text{TF},i},\sigma_{2,i}),
\end{align}
and therefore the per-galaxy likelihood can be written as
\begin{align}
\mathcal L_i
&= \int dy_{\text{TF}}\;
\mathcal N\!\left(\hat x_i;\frac{y_{\text{TF}}-c}{s},\sigma_{1,i}\right)\,
\mathcal N(\hat y_i;y_{\text{TF}},\sigma_{2,i})\,
p(y_{\text{TF}}).
\end{align}

\subsubsection{Closed Form for a Top-Hat Model for $y_{\text{TF},i}$}
Let $y_{\text{TF},i}\sim\text{Uniform}(y_{\min},y_{\max})$, i.e.,
\begin{align}
p(y_{\text{TF},i})=
\begin{cases}
\frac{1}{y_{\max}-y_{\min}}, & y_{\min}\le y_{\text{TF},i}\le y_{\max},\\
0, & \text{otherwise}.
\end{cases}
\end{align}
Then
\begin{align}
\mathcal L_i
&= \frac{1}{y_{\max}-y_{\min}}
\int_{y_{\min}}^{y_{\max}} dy_{\text{TF}}\;
\mathcal N\!\left(\hat x_i;\frac{y_{\text{TF}}-c}{s},\sigma_{1,i}\right)\,
\mathcal N(\hat y_i;y_{\text{TF}},\sigma_{2,i})\\
&= \frac{|s|}{y_{\max}-y_{\min}}\;
\mathcal N\!\left(\hat y_i; c+s\hat x_i,\ \sigma_{\text{tot},i}\right)
\left[
\Phi\!\left(\frac{y_{\max}-\mu_{*,i}}{\sigma_{*,i}}\right)
-
\Phi\!\left(\frac{y_{\min}-\mu_{*,i}}{\sigma_{*,i}}\right)
\right],
\end{align}
where $\Phi$ is the standard normal CDF and
\begin{align}
\sigma_{\text{tot},i}^2 &= s^2\sigma_{1,i}^2+\sigma_{2,i}^2,\\
\mu_{*,i} &= \frac{(s\hat x_i+c)\,\sigma_{2,i}^2+\hat y_i\,s^2\sigma_{1,i}^2}{\sigma_{\text{tot},i}^2},\\
\sigma_{*,i}^2 &= \frac{s^2\sigma_{1,i}^2\sigma_{2,i}^2}{\sigma_{\text{tot},i}^2}.
\end{align}

\paragraph{Case of no limits on $y_{\text{TF},i}$}
If $p(y_{\text{TF},i})$ is taken to be (improper) uniform on $\mathbb{R}$, the truncated-CDF factor tends to 1 and
\begin{align}
\mathcal L_i \propto |s|\;\mathcal N\!\left(\hat y_i; c+s\hat x_i,\ \sigma_{\text{tot},i}\right).
\end{align}
Without the CDF factor, $\sigma_{\text{int},x}$ and $\sigma_{\text{int},y}$ are degenerate and cannot be determined
independently.

These cases are implemented in {\tt base.stan} and when run with Ariel's mock returns the input $s$ and $c$ to incredible precision.
\subsection{Sample Selection}
\label{sec:selection}
\subsubsection{DESI TF Sample Selection}
In practice, sample selection can bias the analysis because the probability that an object enters the final
sample need not be independent of its measured properties.
A classic example is Malmquist bias: in a magnitude-limited survey, objects near the detection threshold are
preferentially scattered into the sample if they are intrinsically brighter (or scattered brighter) than average.

In the DESI TF survey, the initial parent sample is defined by the SGA catalog.
We assume that SGA inclusion is complete above its angular-size cutoff and that, conditional on the TF model,
the SGA selection is independent of the TF observables.  In particular, there are no low surface-brightness galaxies that escape
inclusion in the SGA catalog conditional on the angular size selection.
Concretely, letting $S_{\text{SGA}}\in\{0,1\}$ denote
SGA inclusion, we assume
\begin{align}
p(\hat x_i,\hat y_i \mid \theta, S_{\text{SGA},i}=1) = p(\hat x_i,\hat y_i \mid \theta).
\end{align}
Under this conditional-independence assumption, the SGA cutoff contributes only an
overall constant to the likelihood and therefore does not affect TF parameter estimation.

The observed TF sample is then sculpted by DESI fiber allocation and subsequent redshift-measurement success.
For the moment, we assume these processes are independent of galaxy properties, so they
enter only through an overall completeness factor and do not need to be modeled explicitly in the likelihood.
This assumption should be tested, since fiber allocation and redshift success can depend on quantities such as
angular size, apparent magnitude and surface brightness.

Finally, we apply additional quality cuts to mitigate catastrophic
outliers and to restrict the sample to galaxies for which
the TF model is expected to be valid (e.g.\ excluding dwarf galaxies whose dynamics are not well described by
the normal-galaxy TF relation).
These cuts are modeled as hard selection on the measured observables for each galaxy:
$(\hat x_i,\hat y_i)\in\mathcal S$, where $\mathcal S$ is the selection region.
This is the sample selection considered in this section.

\subsubsection{Model}
Given the model in \S\ref{sec:model}, one could also introduce a model for the abundance of the parent galaxy population
as a function of redshift (e.g., constant per comoving number density).
The expected number of sample galaxies, $\bar N$ is then calculable from the model and is dependent
on the TF parameters. The realized sample size could then inform the inference of the TF parameters.

For simplicity and tractability, we do not introduce a model for the parent population abundance
and instead treat the expected number of observed galaxies $\bar{N}$ as a free parameter in the likelihood:
$\bar N$ does not depend on the TF parameters.
In this case, the TF parameters are constrained only by the observed distribution of $(\hat x,\hat y)$.

\subsubsection{Total Likelihood }
Assuming (i) a Poisson model for the observed sample size and (ii) conditional independence of galaxy measurements,
the total (extended) likelihood is
\begin{align}
\mathcal L(\theta,\bar N;\{\hat x_i\},\{\hat y_i\})
&=
\frac{e^{-\bar N}\bar N^{N}}{N!}
\ \prod_{i=1}^{N}
p(\hat x_i,\hat y_i \mid \theta, S_i=1),
\end{align}
where $S_i=1$ denotes that galaxy $i$ is included by the selection.
The $\bar{N}$ is shown as a reminder that if it depends on parameters of interest, it also contributes to the parameter fitting.
In our case it is a dummy model parameter that we profile over so that relevant contribution to the likelihood is
\begin{align}
\mathcal L(\theta; \{\hat x_i\},\{\hat y_i\})
& \propto
\prod_{i=1}^{N}
p(\hat x_i,\hat y_i \mid \theta, S_i=1),
\end{align}

For hard cuts applied to the \emph{measured} observables, the selected-sample (truncated) per-galaxy density is
\begin{align}
p(\hat x_i,\hat y_i \mid \theta, S_i=1)
&=
\frac{\mathcal{L}_i
}{
P(S_i=1\mid \theta)
},
\\
P(S_i=1\mid \theta)
&=
\int\!\!\!\int_{(\hat x,\hat y)\in\mathcal S_i}
p(\hat x,\hat y \mid \theta)\, d\hat x\, d\hat y.
\end{align}

\subsubsection{Selection domain: upper limit in the measured quantity $\hat{y}$}
\label{subsec:selection_yhatmax}
We can mitigate the effect of dwarf galaxies in the sample by imposing an absolute magnitude criterion.
We consider a sample constructed by imposing an \emph{upper limit} on the measured value $\hat{y}$, so 
$\mathcal S_i $ is defined by
\begin{align}
\hat y_i\le \hat y_{\max}.
\end{align}
The $y_{\max}$ is intended to eliminate dwarf galaxies from the sample, so think of
sacrificing completeness for purity, which should be OK considering the large size of the DESI TF sample.

Then
\begin{align}
P(S_i=1\mid \theta)
&=
\frac{1}{y_{\max}-y_{\min}}
\int_{y_{\min}}^{y_{\max}}
\Phi\!\left(\frac{\hat{y}_{\max}-y_{\text{TF}}}{\sigma_{2,i}}\right)\,dy_{\text{TF}} \\
&=\frac{1}{y_{\max}-y_{\min}}
\Bigg[
(\hat y_{\max}-y_{\min})\,\Phi\!\left(\frac{\hat y_{\max}-y_{\min}}{\sigma_{2,i}}\right)
+\sigma_{2,i}\,\phi\!\left(\frac{\hat y_{\max}-y_{\min}}{\sigma_{2,i}}\right) \notag\\
&\qquad\qquad
+(y_{\max}-\hat y_{\max})\,\Phi\!\left(\frac{\hat y_{\max}-y_{\max}}{\sigma_{2,i}}\right)
-\sigma_{2,i}\,\phi\!\left(\frac{\hat y_{\max}-y_{\max}}{\sigma_{2,i}}\right)
\Bigg],
\end{align}
where $\phi$ is the standard normal PDF.
The integral over $\hat{x}$ is equal to 1 since there is no selection on $\hat{x}$.
The galaxy-dependence of this term enters only through $\sigma_{2,i}$, which depends on the measurement uncertainty $\sigma_{y,i}$.

\subsubsection{Selection domain: upper limit in $\hat{y}$ and a fixed half-plane cut}
\label{subsec:selection_yhatmax_halfplane}
There is also a small population of luminous galaxies that have lower rotational velocities than given by the TF relation.
We consider a sample constructed by imposing (i) an \emph{upper limit} on the measured value $\hat y$
and (ii) a \emph{fixed half-plane cut} in the measured $(\hat x,\hat y)$-plane.
The half-plane cut is selected by the scientist to maintain a pure sample of normal galaxies
without overly sacrificing completeness, and for a good choice the fit results should be insensitive to perturbations of the half-plane cut parameters. 

Given the domain
\begin{align}
\mathcal S_i:\qquad
\hat y_i \le \hat y_{\max},
\qquad
\hat y_i-\bar{s}\,\hat x_i-\bar{c} \ge 0
\ \ \Longleftrightarrow\ \
\bar{s}\,\hat x_i+\bar{c} \le \hat y_i \le \hat y_{\max},
\end{align}
where $(\bar{s},\bar{c})$ are fixed constants defining the half-plane boundary, introduce the sheared coordinates $(\hat u,\hat y)$ by defining
\begin{equation}
\hat u \equiv \hat y - \bar{s}\,\hat x - \bar{c},
\qquad\text{and}\qquad
\hat y \equiv \hat y.
\end{equation}
In these coordinates, the oblique constraint becomes the constant bound
\begin{equation}
\hat y-\bar{s}\,\hat x-\bar{c} \ge 0 \quad\Longleftrightarrow\quad \hat u \ge 0,
\end{equation}
and the upper cut remains
\begin{equation}
\hat y \le \hat y_{\max}.
\end{equation}
Therefore the selection region is
\begin{equation}
\mathcal S_i=\{(\hat u,\hat y):\ \hat u\ge 0,\ \hat y\le \hat y_{\max}\}.
\end{equation}
The inverse transformation is
\begin{equation}
\hat x = \frac{\hat y-\bar{c}-\hat u}{\bar{s}},
\qquad
\hat y=\hat y,
\end{equation}
and the Jacobian determinant is constant:
\begin{equation}
\left|\frac{\partial(\hat x,\hat y)}{\partial(\hat u,\hat y)}\right|=\frac{1}{|\bar{s}|},
\qquad\text{so}\qquad
d\hat x\,d\hat y = \frac{1}{|\bar{s}|}\,d\hat u\,d\hat y.
\end{equation}

The selection probability can be written in the new coordinates as
\begin{align}
P(S_i=1\mid\theta)
& =
\int dy_{\mathrm{TF}}\; p(y_{\mathrm{TF}})
\int_{-\infty}^{\hat y_{\max}} d\hat y
\int_{0}^{\infty} d\hat u\;
\frac{1}{|\bar{s}|}\,
\mathcal N\!\left(\frac{\hat y-\bar{c}-\hat u}{\bar{s}};\frac{y_{\mathrm{TF}}-c}{s},\sigma_{1,i}\right)\,
\mathcal N\!\left(\hat y;y_{\mathrm{TF}},\sigma_{2,i}\right)
\end{align}

Given the parameterization
\begin{equation}
\rho \;=\; \frac{\sigma_{2,i}}{\sqrt{\sigma_{2,i}^2 + \bar{s}^2\,\sigma_{1,i}^2}}
\end{equation}
\begin{equation}
\alpha =
\frac{\bar{c} - \left(y_{\mathrm{TF},i}-\bar{s}\,\frac{y_{\mathrm{TF},i}-c}{s}\right)}{\sqrt{\sigma_{2,i}^2 + \bar{s}^2\,\sigma_{1,i}^2}}
\end{equation}
\begin{equation}
\beta = \frac{\hat y_{\max} - y_{\mathrm{TF},i}}{\sigma_{2,i}}
\end{equation}
\begin{align}
P(S_i=1\mid\theta)
& =
\int dy_{\mathrm{TF}}\; p(y_{\mathrm{TF}})
\Phi_2\left(-\alpha, \beta; -\rho \right)
\end{align}
by definition, where $\Phi_2$ is the bivariate standard normal cumulative distribution function.
This integral has no analytic solution.

\paragraph{Closed Form for a Top-Hat Model for $y_{\text{TF},i}$}
For the uniform prior $y_{\text{TF}}\sim\text{Uniform}(y_{\min},y_{\max})$, i.e., $p(y_{\text{TF}})=1/(y_{\max}-y_{\min})$, this becomes
\begin{align}
P(S_i=1\mid\theta)
& = \frac{1}{y_{max}-y_{min}}
\int_{y_{min}}^{y_{max}} dy_{\mathrm{TF}}
\Phi_2\left(-\alpha, \beta; -\rho \right).
\end{align}


\subsubsection{Selection domain: upper limit in $\hat{y}$ and a two-sided parallel half-plane cut}
To handle potential catastrophic outliers on both sides of the TF relation, we can consider a sample constructed by imposing (i) an \emph{upper limit} on the measured value $\hat y$ and (ii) a \emph{two-sided parallel half-plane cut} in the measured $(\hat x,\hat y)$-plane.
The selection domain is
\begin{equation}
\mathcal S_i:\qquad
\bar{s}\,\hat x_i+\bar{c}_1 \;\le\; \hat y_i \;\le\; \min\!\big\{\hat y_{\max},\;\bar{s}\,\hat x_i+\bar{c}_2\big\}.
\end{equation}
In the sheared coordinates $\hat u\equiv\hat y-\bar{s}\,\hat x-\bar{c}_1$, the lower
oblique cut gives $\hat u\ge0$ as before, while the upper oblique cut
$\hat y\le\bar{s}\,\hat x+\bar{c}_2$ becomes the constant bound
\begin{equation}
\hat u \;\le\; \bar{c}_2-\bar{c}_1,
\end{equation}
so the selection region is
\begin{equation}
\mathcal S_i=\bigl\{(\hat u,\hat y):\;
0\le\hat u\le\bar{c}_2-\bar{c}_1,\quad
\hat y\le\hat y_{\max}\bigr\}.
\end{equation}
The constraint on $\hat u$ is a finite interval, so the integral over the
selection region can be decomposed as a difference of two quadrant
integrals:
\begin{equation}
P(\hat u\ge0,\;\hat u\le\bar{c}_2-\bar{c}_1,\;\hat y\le\hat y_{\max})
\;=\;
P(\hat u\ge0,\;\hat y\le\hat y_{\max})
\;-\;
P(\hat u\ge\bar{c}_2-\bar{c}_1,\;\hat y\le\hat y_{\max}).
\end{equation}
Each term is a bivariate normal CDF of the same form as before. Defining
\begin{equation}
\rho \;=\; \frac{\sigma_{2,i}}{\sqrt{\sigma_{2,i}^2+\bar{s}^2\,\sigma_{1,i}^2}},
\end{equation}
\begin{equation}
\alpha_1 \;=\;
\frac{\bar{c}_1-\!\left(y_{\mathrm{TF},i}
  -\bar{s}\,\dfrac{y_{\mathrm{TF},i}-c}{s}\right)}
{\sqrt{\sigma_{2,i}^2+\bar{s}^2\,\sigma_{1,i}^2}},
\qquad
\alpha_2 \;=\;
\frac{\bar{c}_2-\!\left(y_{\mathrm{TF},i}
  -\bar{s}\,\dfrac{y_{\mathrm{TF},i}-c}{s}\right)}
{\sqrt{\sigma_{2,i}^2+\bar{s}^2\,\sigma_{1,i}^2}},
\end{equation}
\begin{equation}
\beta \;=\; \frac{\hat y_{\max}-y_{\mathrm{TF},i}}{\sigma_{2,i}},
\end{equation}
the selection probability is
\begin{align}
P(S_i=1\mid\theta)
&=\int dy_{\mathrm{TF}}\;p(y_{\mathrm{TF}})\;
\Big[\Phi_2\!\left(-\alpha_1,\;\beta;\;-\rho\right)
     -\Phi_2\!\left(-\alpha_2,\;\beta;\;-\rho\right)\Big].
\end{align}
Note that $\alpha_1$ and $\alpha_2$ differ only by the replacement
$\bar{c}_1\to\bar{c}_2$, and the correlation parameter $\rho$ is
identical in both terms since it depends only on $\bar{s}$.

\paragraph{Closed Form for a Top-Hat Model for $y_{\text{TF},i}$}
For the uniform prior $y_{\text{TF}}\sim\text{Uniform}(y_{\min},y_{\max})$, i.e., $p(y_{\text{TF}})=1/(y_{\max}-y_{\min})$, this becomes
\begin{align}
P(S_i=1\mid\theta)
&=\frac{1}{y_{\max}-y_{\min}}
\int_{y_{\min}}^{y_{\max}} dy_{\mathrm{TF}}\;
\Big[\Phi_2\!\left(-\alpha_1,\;\beta;\;-\rho\right)
     -\Phi_2\!\left(-\alpha_2,\;\beta;\;-\rho\right)\Big].
\end{align}


\subsection{Priors}
Use flat priors for $(s,c)$ and weakly informative priors for the intrinsic scatters:
\begin{align}
\sigma_{\text{int},x} &\sim \text{Half-Cauchy}\!\left(0, 0.3\right),\\
\sigma_{\text{int},y} &\sim \text{Half-Cauchy}\!\left(0, 0.3\right).
\end{align}